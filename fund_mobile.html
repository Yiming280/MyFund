<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FundLite</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="max-w-md mx-auto p-4 pb-10">
        <header class="py-6 text-center">
            <h1 class="text-2xl font-bold text-blue-600">FundLite</h1>
            <p class="text-xs text-gray-400">å®æ—¶ä¼°å€¼ Â· æˆæœ¬è¿˜åŸ Â· ä¼‘å¸‚è‡ªåŠ¨é‡ç½®</p>
            <button @click="batchImport" class="text-[10px] text-blue-500 underline mt-1">æ‰¹é‡åŒæ­¥æŒä»“</button>
        </header>

        <div class="flex gap-2 mb-6">
            <input v-model="searchCode" @keyup.enter="fetchData" placeholder="åŸºé‡‘ä»£ç  (å¦‚ 001592)" 
                    class="flex-1 p-3 rounded-xl border-none shadow focus:ring-2 focus:ring-blue-400 outline-none">
            <button @click="fetchData" class="bg-blue-600 text-white px-5 py-3 rounded-xl shadow hover:bg-blue-700 active:scale-95 transition-transform">æŸ¥è¯¢</button>
        </div>

        <div v-if="fund" class="bg-white rounded-2xl shadow-lg p-5 mb-6 border border-white">
            <div class="flex justify-between items-start mb-4">
                <div class="pr-2">
                    <h2 class="text-lg font-bold text-gray-800 leading-tight">{{ fund.name }}</h2>
                    <p class="text-gray-400 text-xs mt-1">{{ fund.fundcode }}</p>
                </div>
                <button @click="toggleFav" class="shrink-0 text-sm px-3 py-1 rounded-full border border-blue-500 text-blue-500 active:bg-blue-50">
                    {{ isFav ? 'â­ å·²åœ¨è‡ªé€‰' : 'â• åŠ å…¥è‡ªé€‰' }}
                </button>
            </div>
            <div class="flex justify-between items-end mb-4">
                <div>
                    <p class="text-[10px] text-gray-400">å½“å‰ä¼°å€¼ ({{ fund.gztime }})</p>
                    <p :class="fund.gszzl >= 0 ? 'text-red-500' : 'text-green-500'" class="text-3xl font-black">
                        {{ fund.gsz }} <span class="text-sm font-normal">{{ fund.gszzl >= 0 ? '+' : '' }}{{ fund.gszzl }}%</span>
                    </p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-400">æ˜¨æ—¥å‡€å€¼ ({{ fund.jzrq }})</p>
                    <p class="text-gray-600 font-medium">{{ fund.dwjz }}</p>
                </div>
            </div>

            <div id="chart" class="w-full h-44 bg-gray-50 rounded-xl mt-2 overflow-hidden"></div>

            <div v-if="getFundCost(fund.fundcode)" :class="getStrategy(calcProfit(fund.gsz, fund.fundcode)).bg" class="mt-4 p-3 rounded-xl border flex items-center gap-3 transition-all">
                <span class="text-xl">{{ getStrategy(calcProfit(fund.gsz, fund.fundcode)).icon }}</span>
                <div>
                    <p :class="getStrategy(calcProfit(fund.gsz, fund.fundcode)).text" class="text-xs font-bold">{{ getStrategy(calcProfit(fund.gsz, fund.fundcode)).title }}</p>
                    <p class="text-[10px] text-gray-500 opacity-80">{{ getStrategy(calcProfit(fund.gsz, fund.fundcode)).desc }}</p>
                </div>
            </div>
        </div>

        <div class="mt-8">
            <h3 class="font-bold text-gray-700 mb-3 ml-2 italic text-sm flex justify-between items-center">
                <span>æˆ‘çš„æŒä»“</span>
                <span class="text-[10px] font-normal text-gray-400">ç‚¹å‡»é‡‘é¢/æˆæœ¬å¯ç¼–è¾‘</span>
            </h3>
            
            <div v-for="item in favorites" :key="item.code" 
                @click="searchCode = item.code; fetchData()"
                class="bg-white rounded-xl shadow-sm mb-3 border-l-4 border-blue-500 overflow-hidden cursor-pointer active:bg-gray-50 transition-all">
                
                <div class="grid grid-cols-3 p-4 items-center gap-2">
                    
                    <div class="flex flex-col min-w-0">
                        <p class="font-bold text-gray-800 text-sm truncate mb-1">{{ item.name }}</p>
                        <div class="space-y-0.5">
                            <p class="text-[10px] text-gray-500 flex items-center">
                                <span class="w-8 opacity-60">é‡‘é¢</span>
                                <span @click.stop="setHoldAmount(item)" class="text-blue-600 font-medium hover:underline tracking-tighter">
                                    Â¥{{ item.holdValue || '0.00' }}
                                </span>
                            </p>
                            <p class="text-[10px] text-gray-500 flex items-center">
                                <span class="w-8 opacity-60">æˆæœ¬</span>
                                <span @click.stop="setCost(item)" class="text-blue-600 font-medium hover:underline tracking-tighter">
                                    {{ item.cost || 'æœªè®¾' }}
                                </span>
                            </p>
                        </div>
                    </div>

                    <div class="flex flex-col items-center border-x border-gray-50">
                        <p :class="item.gszzl >= 0 ? 'text-red-500' : 'text-green-600'" class="font-black text-base tabular-nums">
                            {{ item.gsz || '--' }}
                        </p>
                        <p :class="item.gszzl >= 0 ? 'bg-red-50 text-red-500' : 'bg-green-50 text-green-600'" 
                        class="text-[10px] px-1.5 py-0.5 rounded font-bold mt-1">
                            {{ item.gszzl ? (item.gszzl >= 0 ? '+' : '') + item.gszzl + '%' : '--' }}
                        </p>
                    </div>

                    <div class="flex items-center justify-end gap-2">
                        <div class="text-right">
                            <template v-if="item.cost">
                                <p :class="calcProfit(item.gsz, item.code) >= 0 ? 'text-red-500' : 'text-green-600'" 
                                class="font-bold text-sm tabular-nums">
                                    {{ calcProfit(item.gsz, item.code) >= 0 ? '+' : '' }}{{ (item.holdValue * calcProfit(item.gsz, item.code) / 100).toFixed(2) }}
                                </p>
                                <p :class="calcProfit(item.gsz, item.code) >= 0 ? 'text-red-400' : 'text-green-400'" 
                                class="text-[10px] font-medium leading-none">
                                    {{ calcProfit(item.gsz, item.code) >= 0 ? '+' : '' }}{{ calcProfit(item.gsz, item.code) }}%
                                </p>
                            </template>
                            <p v-else class="text-[10px] text-gray-300 italic">æœªè®¾æˆæœ¬</p>
                        </div>
                        <button @click.stop="removeFav(item.code)" class="text-gray-200 hover:text-red-400 transition-colors p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                </div>
            </div>
            
            <div v-if="favorites.length === 0" class="text-center py-12">
                <div class="text-gray-300 text-3xl mb-2">ğŸ“Š</div>
                <p class="text-gray-400 text-xs">æš‚æ— è‡ªé€‰ï¼Œæœç´¢åç‚¹å‡»â€œåŠ å…¥è‡ªé€‰â€</p>
            </div>
        </div>

    <script>
        window.jsonpgz = (data) => { window.__currentFundData = data; };
        const { createApp, ref, onMounted, computed, nextTick } = Vue;

        createApp({
            setup() {
                const searchCode = ref('');
                const fund = ref(null);
                const favorites = ref(JSON.parse(localStorage.getItem('my_lite_funds') || '[]'));
                const historyData = ref(JSON.parse(localStorage.getItem('fund_history_points') || '{}'));
                const isUpdating = ref(false);
                let myChart = null;

                const isFav = computed(() => fund.value && favorites.value.some(f => f.code === fund.value.fundcode));

                // 1. è®¾ç½®æŒä»“æˆæœ¬ (æ‰‹åŠ¨è¾“å…¥)
                const setCost = (item) => {
                    const val = prompt(`[${item.name}]\nè¯·è¾“å…¥æŒä»“æˆæœ¬ä»· (å‡ä»·):`, item.cost || "");
                    if (val !== null) {
                        item.cost = val;
                        save();
                    }
                };

                // 2. è®¾ç½®æŒæœ‰é‡‘é¢ (æ‰‹åŠ¨è¾“å…¥)
                const setHoldAmount = (item) => {
                    const val = prompt(`[${item.name}]\nè¯·è¾“å…¥å½“å‰æŒæœ‰æ€»é‡‘é¢ (å…ƒ):`, item.holdValue || "");
                    if (val !== null) {
                        item.holdValue = val;
                        save();
                    }
                };
                
                // æ ¸å¿ƒå‡½æ•° 1: ç§‘å­¦å»ºè®®ç®—æ³• (é˜¶æ¢¯åŠ ä»“/ç›®æ ‡æ­¢ç›ˆ)
                const getStrategy = (profit) => {
                    const p = parseFloat(profit);
                    if (p >= 10) return { title: 'ç›®æ ‡è¾¾æˆï¼šåˆ†æ‰¹æ­¢ç›ˆ', desc: 'æ”¶ç›Šå·²è¶…10%ï¼Œå»ºè®®è½è¢‹ä¸ºå®‰ï¼Œç­‰å¾…å›è°ƒ', icon: 'ğŸ’°', bg: 'bg-red-50 border-red-100', text: 'text-red-700' };
                    if (p >= 5) return { title: 'åŠ¿å¤´è‰¯å¥½ï¼šæŒç»­è§‚å¯Ÿ', desc: 'æ”¶ç›Šè¶…5%ï¼Œå¯è®¾ç§»åŠ¨æ­¢ç›ˆï¼Œä¸ç ´ä½ä¸å–', icon: 'ğŸ“ˆ', bg: 'bg-orange-50 border-orange-100', text: 'text-orange-700' };
                    if (p <= -10) return { title: 'æ˜¾è‘—ä½ä¼°ï¼šå»ºè®®è¡¥ä»“', desc: 'è·Œå¹…è¶…è¿‡10%ï¼Œè§¦å‘ä»·å€¼åŠ ä»“ä¿¡å·', icon: 'ğŸ’', bg: 'bg-green-50 border-green-100', text: 'text-green-700' };
                    if (p <= -5) return { title: 'ä»·å€¼åŒºé—´ï¼šå®šæŠ•ç»§ç»­', desc: 'è½»å¾®æµ®äºï¼Œå»ºè®®æŒ‰åŸè®¡åˆ’æ‰§è¡Œå®šæŠ•', icon: 'ğŸ›’', bg: 'bg-blue-50 border-blue-100', text: 'text-blue-700' };
                    return { title: 'æŒæœ‰å¾…æ¶¨', desc: 'å½“å‰å¤„äºæ³¢åŠ¨å¹³ç¨³æœŸï¼Œå»ºè®®ä¿æŒä»“ä½ä¸åŠ¨', icon: 'â˜•', bg: 'bg-gray-50 border-gray-100', text: 'text-gray-600' };
                };

                // æ ¸å¿ƒå‡½æ•° 2: è®¡ç®—ç›ˆäº
                const calcProfit = (currentGsz, code) => {
                    const item = favorites.value.find(f => f.code === code);
                    if (!item || !item.cost || !currentGsz) return 0;
                    return (((parseFloat(currentGsz) - parseFloat(item.cost)) / parseFloat(item.cost)) * 100).toFixed(2);
                };

                // æ ¸å¿ƒå‡½æ•° 3: æ‰¹é‡åŒæ­¥
                const batchImport = () => {
                    const input = prompt("æ‰¹é‡è¾“å…¥ï¼šä»£ç ,æˆæœ¬,æ€»é‡‘é¢ï¼ˆå¤šæ¡æ¢è¡Œï¼‰\n001592,1.23,5000");
                    if (!input) return;
                    input.split('\n').forEach(line => {
                        const [code, cost, val] = line.split(/[ï¼Œ,]/);
                        if (code && cost) {
                            const item = favorites.value.find(f => f.code === code.trim());
                            if (item) { item.cost = cost; item.holdValue = val; }
                            else favorites.value.push({ name: 'å¾…åŠ è½½', code: code.trim(), cost: cost, holdValue: val });
                        }
                    });
                    save();
                    updateAllFavorites();
                };

                const getFundCost = (code) => favorites.value.find(f => f.code === code)?.cost;

                // åˆ¤æ–­weekendå’Œäº¤æ˜“æ—¶æ®µçš„æ ¸å¿ƒå‡½æ•°
                const isTradeTime = () => {
                    const now = new Date();
                    const day = now.getDay(); // 0æ˜¯å‘¨æ—¥ï¼Œ6æ˜¯å‘¨å…­
                    const hour = now.getHours();
                    const min = now.getMinutes();
                    const timeStr = `${hour.toString().padStart(2,'0')}${min.toString().padStart(2,'0')}`;

                    // åˆ¤æ–­æ˜¯å¦ä¸ºå‘¨æœ«
                    const isWeekend = (day === 0 || day === 6);
                    // åˆ¤æ–­æ˜¯å¦åœ¨äº¤æ˜“æ—¶æ®µ (9:25-11:35, 12:55-15:05)
                    const isTradingHour = (timeStr >= "0925" && timeStr <= "1135") || (timeStr >= "1255" && timeStr <= "1505");
                    
                    return !isWeekend && isTradingHour;
                };

                // æ–°å¢ï¼šåˆ¤æ–­ä»Šå¤©æ˜¯å¦ä¸ºå·¥ä½œæ—¥ï¼ˆç”¨äºå›¾è¡¨é‡ç½®é€»è¾‘ï¼‰
                const isWorkDay = () => {
                    const day = new Date().getDay();
                    return day !== 0 && day !== 6;
                };

                // 3. ä¿®æ­£å›¾è¡¨ä¼‘å¸‚æ˜¾ç¤ºé€»è¾‘
                const updateChart = () => {
                    const dom = document.getElementById('chart');
                    if (!dom || !fund.value) return;
                    if (!myChart) myChart = echarts.init(dom);
                    const points = historyData.value[fund.value.fundcode] || [];
                    
                    // è·å–å½“å‰æ—¶é—´åˆ¤æ–­
                    const now = new Date();
                    const day = now.getDay();
                    const isWeekend = (day === 0 || day === 6);

                    // å¦‚æœæ˜¯å‘¨æœ«æˆ–è€…æ‰“ç‚¹æ•°æ®ä¸ºç©ºï¼Œæ˜¾ç¤ºä¼‘å¸‚
                    if (isWeekend || (points.length === 0 && !isTradeTime())) {
                        myChart.setOption({
                            title: { 
                                text: isWeekend ? 'å‘¨æœ«ä¼‘å¸‚ä¸­' : 'ç­‰å¾…å¼€ç›˜...', 
                                left: 'center', top: 'center', 
                                textStyle: { color: '#ccc', fontSize: 13, fontWeight: 'normal' } 
                            },
                            xAxis: { show: false }, 
                            yAxis: { show: false }, 
                            grid: { show: false },
                            series: []
                        }, true);
                        return;
                    }

                    // ç»˜å›¾é€»è¾‘ä¿æŒåŸæ ·ï¼Œç¡®ä¿ç½‘æ ¼å’Œè½´çº¿æ˜¾ç¤º
                    myChart.setOption({
                        title: { show: false },
                        grid: { left: '15%', right: '5%', top: '15%', bottom: '15%', show: true },
                        xAxis: { 
                            show: true, type: 'category', data: points.map(p => p.time),
                            axisLabel: { fontSize: 9, color: '#999', interval: Math.floor(points.length / 5) }
                        },
                        yAxis: { 
                            show: true, type: 'value', scale: true, 
                            splitLine: { show: true, lineStyle: { type: 'dashed', color: '#f3f3f3' } },
                            axisLabel: { fontSize: 9, color: '#999' }
                        },
                        series: [{
                            data: points.map(p => p.val),
                            type: 'line', smooth: true, showSymbol: false,
                            lineStyle: { color: '#3b82f6', width: 2 },
                            areaStyle: { color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{offset: 0, color: 'rgba(59,130,246,0.2)'}, {offset: 1, color: 'transparent'}]) }
                        }]
                    }, true);
                };

                const fetchData = async () => {
                    if (!searchCode.value || isUpdating.value) return;
                    isUpdating.value = true;
                    const script = document.createElement('script');
                    script.src = `https://fundgz.1234567.com.cn/js/${searchCode.value}.js?rt=${Date.now()}`;
                    document.body.appendChild(script);
                    script.onload = () => {
                        if(window.__currentFundData) {
                            fund.value = window.__currentFundData;
                            recordPoint(fund.value);
                            nextTick(updateChart);
                        }
                        script.remove();
                        isUpdating.value = false;
                    };
                    script.onerror = () => { isUpdating.value = false; alert("æŸ¥è¯¢å¤±è´¥"); };
                };

                const recordPoint = (fData) => {
                    const code = fData.fundcode;
                    const time = fData.gztime.split(' ')[1];
                    const val = parseFloat(fData.gsz);
                    if (isNaN(val) || val === 0) return;
                    if (!historyData.value[code]) historyData.value[code] = [];
                    const points = historyData.value[code];
                    if (points.length === 0 || points[points.length - 1].time !== time) {
                        points.push({ time, val });
                        if (points.length > 240) points.shift();
                        localStorage.setItem('fund_history_points', JSON.stringify(historyData.value));
                    }
                };

                const updateAllFavorites = () => {
                    if (!isTradeTime() && favorites.value.length > 0) return;
                    favorites.value.forEach(item => {
                        const s = document.createElement('script');
                        s.src = `https://fundgz.1234567.com.cn/js/${item.code}.js?rt=${Date.now()}`;
                        document.body.appendChild(s);
                        s.onload = () => {
                            const d = window.__currentFundData;
                            if(d && d.fundcode === item.code) {
                                item.gsz = d.gsz; item.gszzl = d.gszzl; item.dwjz = d.dwjz; // åŒæ­¥æ˜¨æ—¥å‡€å€¼
                                recordPoint(d);
                            }
                            s.remove();
                        };
                    });
                };

                const toggleFav = () => {
                    const idx = favorites.value.findIndex(f => f.code === fund.value.fundcode);
                    if (idx > -1) favorites.value.splice(idx, 1);
                    else favorites.value.push({ name: fund.value.name, code: fund.value.fundcode, dwjz: fund.value.dwjz });
                    save();
                };

                const save = () => localStorage.setItem('my_lite_funds', JSON.stringify(favorites.value));

                onMounted(() => {
                    updateAllFavorites();
                    setInterval(updateAllFavorites, 60000);
                    window.addEventListener('resize', () => myChart && myChart.resize());
                });

                return { 
                    searchCode, fund, favorites, isFav, fetchData, toggleFav, isUpdating,
                    calcProfit, getFundCost, getStrategy, batchImport, setCost, setHoldAmount,
                    removeFav: (code) => { favorites.value = favorites.value.filter(f => f.code !== code); save(); }
                };
            }
        }).mount('#app');
    </script>
</body>
</html>