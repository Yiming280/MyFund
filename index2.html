<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的指数基金看板</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen pb-10">
    <div id="app" class="max-w-xl mx-auto p-4">
        <header class="text-center py-6">
            <h1 class="text-3xl font-extrabold text-blue-600">FundTracker</h1>
            <p class="text-gray-500">实时估值与趋势分析</p>
        </header>

        <div class="flex gap-2 mb-6">
            <input v-model="searchCode" @keyup.enter="fetchData" placeholder="输入基金代码 (如 000001)" 
                   class="flex-1 p-3 rounded-lg border-none shadow-md focus:ring-2 focus:ring-blue-400 outline-none">
            <button @click="fetchData" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-blue-700 transition">
                查询
            </button>
        </div>

        <div v-if="fund" class="bg-white rounded-2xl shadow-xl overflow-hidden mb-6">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">{{ fund.name }} <span class="text-sm font-normal text-gray-400">{{ fund.fundcode }}</span></h2>
                    <div class="flex gap-4 mt-4 mb-2">
                        <button @click="showType='realtime'; fetchData()" 
                                :class="showType==='realtime'?'text-blue-600 font-bold border-b-2 border-blue-600':'text-gray-400'">
                            今日估值
                        </button>
                        <button @click="showType='history'; fetchData()" 
                                :class="showType==='history'?'text-blue-600 font-bold border-b-2 border-blue-600':'text-gray-400'">
                            30日历史
                        </button>
                    </div>
                    <button @click="toggleFav" class="text-sm px-3 py-1 rounded-full border border-blue-500 text-blue-500 hover:bg-blue-50">
                        {{ isFav ? '⭐ 已在自选' : '➕ 加入自选' }}
                    </button>
                </div>
                <div class="flex justify-between items-end">
                    <div>
                        <p class="text-gray-400 text-xs">实时估值 ({{ fund.gztime }})</p>
                        <p :class="fund.gszzl >= 0 ? 'text-red-500' : 'text-green-500'" class="text-4xl font-black">
                            {{ fund.gsz }} 
                            <span class="text-lg font-normal">{{ fund.gszzl >= 0 ? '+' : '' }}{{ fund.gszzl }}%</span>
                        </p>
                    </div>
                </div>
            </div>
            <div id="chart" class="w-full h-64 bg-gray-50 border-t"></div>
        </div>

        <div class="mt-8">
            <h3 class="text-lg font-bold text-gray-700 mb-4 px-2 italic">我的自选</h3>
            <div v-for="item in favorites" :key="item.code" 
                class="bg-white p-4 rounded-xl shadow-sm mb-3 flex justify-between items-center border-l-4 border-blue-500 hover:shadow-md transition cursor-pointer"
                @click="searchCode = item.code; fetchData()">
                
                <div>
                    <p class="font-bold text-gray-800">{{ item.name }}</p>
                    <p class="text-xs text-gray-400">{{ item.code }}</p>
                </div>

                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="text-sm font-bold" :class="item.gszzl >= 0 ? 'text-red-500' : 'text-green-500'">
                            {{ item.gsz || '--' }}
                        </p>
                        <p class="text-xs" :class="item.gszzl >= 0 ? 'text-red-500' : 'text-green-500'">
                            {{ item.gszzl ? (item.gszzl >= 0 ? '+' : '') + item.gszzl + '%' : '--' }}
                        </p>
                    </div>
                    <button @click.stop="removeFav(item.code)" class="text-gray-300 hover:text-red-500 p-2">✕</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, computed } = Vue;

        createApp({
            setup() {
                const searchCode = ref('');
                const fund = ref(null);
                const showType = ref('realtime');
                // 初始化自选列表
                const favorites = ref(JSON.parse(localStorage.getItem('my_funds') || '[]'));
                let chart = null;

                // 【1. isFav 逻辑】判断当前查询的基金是否已在自选里
                const isFav = computed(() => {
                    return fund.value && favorites.value.some(f => f.code === fund.value.fundcode);
                });

                // 【2. 渲染图表函数】
                const renderChart = (xData, yData, hintText = '') => {
                    const chartDom = document.getElementById('chart');
                    if (!chartDom) return;
                    if (!chart) chart = echarts.init(chartDom);
                    
                    // 先隐藏加载状态
                    chart.hideLoading();
                    
                    const option = {
                        tooltip: { trigger: 'axis' },
                        xAxis: { type: 'category', data: xData },
                        yAxis: { type: 'value', scale: true },
                        series: [{
                            data: yData,
                            type: 'line',
                            smooth: true,
                            areaStyle: { color: 'rgba(59, 130, 246, 0.1)' },
                            lineStyle: { color: '#3b82f6', width: 2 }
                        }]
                    };
                    
                    // 如果有提示文字
                    if (hintText) {
                        option.graphic = {
                            type: 'text',
                            left: 'center',
                            top: 'middle',
                            style: {
                                text: hintText,
                                fontSize: 14,
                                fill: '#9ca3af',
                                textAlign: 'center'
                            }
                        };
                    }
                    
                    chart.setOption(option, true);
                };

                // 【3. 更新自选列表所有数据的实时数值】
                const updateFavoritesData = async () => {
                    for (let item of favorites.value) {
                        try {
                            const res = await fetch(`http://127.0.0.1:5000/get_fund_realtime?code=${item.code}`);
                            const data = await res.json();
                            item.gsz = data.gsz;
                            item.gszzl = data.gszzl;
                        } catch (e) {
                            console.error("更新自选失败", item.code);
                        }
                    }
                };

                // 【4. 查询按钮的核心逻辑】
                const fetchData = async () => {
                    if (!searchCode.value) return;
                    
                    // 获取图表实例并显示加载状态
                    const chartDom = document.getElementById('chart');
                    if (chartDom && chart) {
                        chart.showLoading({ text: '加载中...', color: '#3b82f6', textColor: '#3b82f6', maskColor: 'rgba(255,255,255,0.8)' });
                    }
                    
                    try {
                        // 先拿基础信息
                        const resBase = await fetch(`http://127.0.0.1:5000/get_fund_realtime?code=${searchCode.value}`);
                        const baseData = await resBase.json();
                        fund.value = baseData; 

                        // 再根据模式画图
                        if (showType.value === 'realtime') {
                            // 获取分时走势数据
                            try {
                                const resTrend = await fetch(`http://127.0.0.1:5000/get_fund_trend?code=${searchCode.value}`);
                                const trendData = await resTrend.json();
                                console.log('分时数据:', trendData);
                                if (trendData.success && trendData.data && trendData.data.length > 0) {
                                    const xData = trendData.data.map(p => p.time);
                                    const yData = trendData.data.map(p => parseFloat(p.data));
                                    renderChart(xData, yData);
                                } else {
                                    // 如果没有分时数据（周末、非交易时段），显示昨日净值和今日估值
                                    const message = trendData.message || '非交易时间\n暂无分时数据';
                                    renderChart(["昨日净值", "今日估值"], [parseFloat(baseData.dwjz), parseFloat(baseData.gsz)], message);
                                }
                            } catch (trendErr) {
                                console.error("获取分时数据失败", trendErr);
                                // 降级显示两个点
                                renderChart(["昨日净值", "今日估值"], [parseFloat(baseData.dwjz), parseFloat(baseData.gsz)], '获取分时数据失败');
                            }
                        } else {
                            const resHist = await fetch(`http://127.0.0.1:5000/get_fund_history?code=${searchCode.value}`);
                            const histData = await resHist.json();
                            renderChart(histData.dates, histData.values);
                        }
                        updateFavoritesData(); // 顺便刷新列表
                    } catch (e) {
                        alert("获取失败，请确认 Python 后端已启动");
                    }
                };

                // 【5. 收藏/取消收藏逻辑】
                const toggleFav = () => {
                    if (!fund.value) return;
                    const index = favorites.value.findIndex(f => f.code === fund.value.fundcode);
                    if (index > -1) {
                        favorites.value.splice(index, 1);
                    } else {
                        favorites.value.push({ 
                            name: fund.value.name, 
                            code: fund.value.fundcode,
                            gsz: fund.value.gsz,
                            gszzl: fund.value.gszzl
                        });
                    }
                    localStorage.setItem('my_funds', JSON.stringify(favorites.value));
                };

                const removeFav = (code) => {
                    favorites.value = favorites.value.filter(f => f.code !== code);
                    localStorage.setItem('my_funds', JSON.stringify(favorites.value));
                };

                // 【6. 页面挂载后的初始化】
                onMounted(() => {
                    updateFavoritesData();
                    setInterval(updateFavoritesData, 60000); // 每分钟刷一次
                });

                // 【非常重要：必须把所有网页上用到的变量/函数都暴露出来】
                return { 
                    searchCode, fund, fetchData, favorites, 
                    showType, isFav, toggleFav, removeFav 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>